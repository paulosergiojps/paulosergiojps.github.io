<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- üîí Desindexar -->
  <meta name="robots" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
  <meta name="googlebot" content="noindex, nofollow, noarchive, nosnippet, noimageindex">

  <title>Quiz de M√∫sicas de Anime ‚Äî S√≥ o Som (YouTube)</title>

  <style>
    :root { --bg:#0b0f14; --panel:#111823; --muted:#8aa0b5; --text:#e6eef6; --accent:#7cc3ff; --accent-2:#9affc3; --danger:#ff7c7c; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;background:radial-gradient(1200px 600px at 10% -10%,#142032,transparent),var(--bg);color:var(--text)}
    .wrap{max-width:960px;margin:32px auto;padding:0 20px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
    header h1{font-size:clamp(20px,3vw,28px);margin:0;letter-spacing:.2px}
    header .tag{font-size:12px;color:var(--muted);background:#0e141d;border:1px solid #1b2635;padding:3px 8px;border-radius:999px}
    .panel{background:linear-gradient(180deg,#0f1622,#0e1520);border:1px solid #1b2635;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .controls{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:720px){.controls{grid-template-columns:1fr 1fr}}
    .btns{display:flex;flex-wrap:wrap;gap:10px}
    button{appearance:none;border:1px solid #1b2635;background:#122033;color:var(--text);padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer;transition:transform .05s ease,filter .2s ease,background .2s ease}
    button:hover{filter:brightness(1.08)} button:active{transform:translateY(1px)}
    .primary{background:linear-gradient(180deg,#17314f,#132a45);border-color:#1e3a5b}
    .accent{background:linear-gradient(180deg,#1b3e2b,#153323);border-color:#234a35}
    .danger{background:linear-gradient(180deg,#3f1b1b,#301414);border-color:#542626}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:center}
    .row label{font-size:13px;color:var(--muted)}
    input[type="number"]{width:100%;padding:9px 10px;border-radius:10px;border:1px solid #1b2635;background:#0f1722;color:var(--text)}
    input[type="checkbox"]{transform:translateY(1px)}
    .status{display:flex;gap:16px;flex-wrap:wrap;margin-top:10px;font-size:13px;color:var(--muted)}
    .status strong{color:var(--accent)}
    .reveal{margin-top:12px;padding:12px;background:#0d1420;border:1px dashed #213149;border-radius:12px;min-height:52px;display:grid;gap:2px}
    .title{font-size:16px;font-weight:700;letter-spacing:.2px}
    .subtitle{font-size:13px;color:var(--muted)}
    details{margin-top:18px} summary{cursor:pointer;user-select:none;color:var(--accent-2);font-weight:700}
    ol{margin:10px 0 0;padding-left:20px} li{margin:4px 0}
    #board{width:100%;min-height:80px;background:#111823;border:1px solid #1b2635;border-radius:12px;display:grid;place-items:center;color:#9fb7cf;font-weight:700;letter-spacing:.3px;text-align:center;padding:8px}

    /* Player YouTube (invis√≠vel depois do handshake) */
    #yt.hidden{position:absolute;left:-9999px;top:-9999px;width:1px;height:1px;opacity:0;pointer-events:none}
    /* Mini-player para o clique inicial */
    #yt.handshake{
      position:fixed; z-index:9999;
      left:50%; top:50%; transform:translate(-50%,-50%);
      width:360px; height:202px; /* 16:9 */
      border:0; box-shadow:0 12px 40px rgba(0,0,0,.5); border-radius:12px;
    }
    @media (max-width:420px){ #yt.handshake{ width:90vw; height:calc(90vw*9/16); } }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Quiz de M√∫sicas de Anime ‚Äî s√≥ o som üéµ</h1>
      <span class="tag">YouTube (sem bibliotecas externas)</span>
    </header>

    <div class="panel">
      <div class="controls">
        <div>
          <div class="btns">
            <button class="primary" id="startBtn">‚ñ∂Ô∏è Come√ßar</button>
            <button id="pauseBtn">‚è∏Ô∏è Pausar</button>
            <button id="resumeBtn">‚ñ∂Ô∏è Continuar</button>
            <button class="accent" id="nextBtn">‚è≠Ô∏è Pr√≥xima</button>
            <button id="revealBtn">üëÄ Revelar</button>
            <button class="danger" id="randomPointBtn" title="Novo ponto aleat√≥rio na mesma faixa">‚§¥Ô∏è Ponto aleat√≥rio</button>
          </div>

          <div class="status">
            <div>Restantes: <strong id="left">0</strong></div>
            <div>Modo: <strong>youtube</strong></div>
          </div>

          <div class="reveal" id="revealBox">
            <div class="title" id="songTitle">(oculto)</div>
            <div class="subtitle" id="songSub">‚Äî</div>
          </div>
        </div>

        <div>
          <div class="row">
            <label for="clipLen">Dura√ß√£o do trecho (segundos)</label>
            <input id="clipLen" type="number" min="5" max="90" step="1" value="20" />
          </div>
          <div class="row">
            <label for="randomStart">Come√ßar em ponto aleat√≥rio</label>
            <input id="randomStart" type="checkbox" checked />
          </div>
          <div class="row">
            <label for="volume">Volume (0‚Äì100)</label>
            <input id="volume" type="number" min="0" max="100" step="5" value="70" />
          </div>
          <div id="board">Clique <b>Come√ßar</b>. Vai surgir um <b>mini-player</b> do YouTube ‚Äî clique uma vez dentro dele para liberar o √°udio; depois ele some e fica s√≥ o som.</div>
        </div>
      </div>

      <details>
        <summary>Ver lista de m√∫sicas</summary>
        <ol id="lista"></ol>
      </details>
    </div>

    <!-- Player YouTube: come√ßa invis√≠vel, vira "handshake" s√≥ no primeiro play -->
    <iframe id="yt" class="hidden"
      title="player oculto"
      allow="autoplay; encrypted-media; picture-in-picture"
      referrerpolicy="origin-when-cross-origin"></iframe>
  </div>

  <script>
    // ===== Lista (resumida; voc√™ pode expandir √† vontade) =====
    const SONGS = [
      { t: "A Cruel Angel's Thesis", a: "Neon Genesis Evangelion" },
      { t: "Tank!", a: "Cowboy Bebop" },
      { t: "Battlecry", a: "Samurai Champloo" },
      { t: "unravel", a: "Tokyo Ghoul" },
      { t: "again", a: "Fullmetal Alchemist: Brotherhood" },
      { t: "Guren no Yumiya", a: "Attack on Titan" },
      { t: "Shinzou wo Sasageyo!", a: "Attack on Titan" },
      { t: "Gurenge", a: "Demon Slayer" },
      { t: "Kaikai Kitan", a: "Jujutsu Kaisen" },
      { t: "THE HERO!! ~Ikareru Kobushi ni Hi wo Tsukero~", a: "One Punch Man" },
      { t: "Silhouette", a: "Naruto Shippuden" },
      { t: "Blue Bird", a: "Naruto Shippuden" },
      { t: "We Are!", a: "One Piece" },
      { t: "KICK BACK", a: "Chainsaw Man" },
      { t: "CHA-LA HEAD-CHA-LA", a: "Dragon Ball Z" },
      { t: "Hikaru nara", a: "Your Lie in April" },
      { t: "crossing field", a: "Sword Art Online" },
      { t: "Kimi no Shiranai Monogatari", a: "Bakemonogatari" },
      { t: "Sorairo Days", a: "Gurren Lagann" },
      { t: "God knows...", a: "Haruhi Suzumiya" }
    ];

    // ===== UI refs =====
    const $ = (s)=>document.querySelector(s);
    const leftEl=$('#left'), titleEl=$('#songTitle'), subEl=$('#songSub');
    const clipLenEl=$('#clipLen'), randomStartEl=$('#randomStart'), volumeEl=$('#volume');
    const listEl=$('#lista'), iframe=$('#yt'), board=$('#board');

    // Render da lista
    listEl.innerHTML = SONGS.map((s,i)=>`<li>${i+1}. ${s.t} ‚Äî ${s.a}</li>`).join('');

    // ===== Estado =====
    let order = Array.from({length:SONGS.length},(_,i)=>i);
    let cursor=0, currentIndex=null, clipTimer=null;
    let didHandshake=false;          // j√° clicou dentro do player uma vez
    let playerReady=false;           // recebeu onReady do player
    const pending=[];                // fila de comandos a enviar ap√≥s ready

    const shuffle=a=>{for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a};
    order = shuffle(order);
    const updateLeft=()=>leftEl.textContent=Math.max(0,order.length-cursor);
    updateLeft();

    const makeQuery=(s)=>`${(s.t||'').replace(/[^\w\s]/g,' ')} ${(s.a||'').replace(/[^\w\s]/g,' ')} anime opening`;
    const randomStartGuess=()=>{ const min=10, max=150; return Math.floor(Math.random()*(max-min+1))+min; };
    const secs=(n)=>Math.max(5,Math.min(90,parseInt(n||'20',10)));

    function buildBaseEmbed(showControls){
      const base='https://www.youtube.com/embed';
      const p=new URLSearchParams({
        autoplay:'1', controls: showControls ? '1' : '0', rel:'0', modestbranding:'1', disablekb:'1', iv_load_policy:'3', playsinline:'1',
        enablejsapi:'1', origin: location.origin
      });
      return `${base}?${p.toString()}`;
    }

    function send(cmd,args=[]){
      if(!playerReady){ pending.push([cmd,args]); return; }
      try{ iframe.contentWindow.postMessage(JSON.stringify({event:'command',func:cmd,args}), 'https://www.youtube.com'); }catch(e){}
    }

    // Recebe eventos do player (onReady / infoDelivery)
    window.addEventListener('message', (ev)=>{
      let data; try{ data = typeof ev.data==='string' ? JSON.parse(ev.data) : ev.data; } catch(_){ return; }
      if (!data) return;

      if (data.event === 'onReady') {
        playerReady = true;
        setTimeout(()=>{ while(pending.length){ const [f,a]=pending.shift(); send(f,a); } }, 50);
      }

      if (data.event === 'infoDelivery' && data.info && typeof data.info.playerState !== 'undefined') {
        if (data.info.playerState === 1 && iframe.classList.contains('handshake')) {
          iframe.classList.remove('handshake');
          iframe.classList.add('hidden');
          board.textContent = 'Tocando‚Ä¶ (YouTube)';
          didHandshake = true;
        }
      }
    }, { passive: true });

    function showMiniPlayer(){
      iframe.classList.remove('hidden');
      iframe.classList.add('handshake');
      board.textContent = 'Clique dentro do mini-player para liberar o √°udio‚Ä¶';
    }

    function hidePlayer(){
      iframe.classList.add('hidden');
      iframe.classList.remove('handshake');
    }

    function stopPlayback(){
      clearTimeout(clipTimer);
      playerReady=false; pending.length=0;
      iframe.src='about:blank';
    }

    function playSong(index, fresh=true){
      currentIndex=index; playerReady=false; pending.length=0;
      const s=SONGS[currentIndex];
      titleEl.textContent='(oculto)';
      subEl.textContent='‚Äî';

      const clip=secs(clipLenEl.value);
      const start=randomStartEl.checked && fresh ? randomStartGuess() : 0;

      // 1) carrega um embed "limpo" (sem search na URL)
      const showControls = !didHandshake;
      iframe.setAttribute('allow','autoplay; encrypted-media; picture-in-picture');
      iframe.src = buildBaseEmbed(showControls);

      // 2) quando o player estiver pronto, pedimos para carregar a playlist de busca
      const q = makeQuery(s);
      send('loadPlaylist', [{ listType: 'search', list: q }, 0, start]);
      // volume
      const vol = Math.max(0, Math.min(100, parseInt(volumeEl.value||'70',10)));
      if (vol === 0) send('mute', []); else { send('unMute', []); send('setVolume', [vol]); }
      // for√ßa tocar
      send('playVideo', []);

      if (!didHandshake) showMiniPlayer(); else hidePlayer();

      clearTimeout(clipTimer);
      clipTimer=setTimeout(()=>nextSong(), clip*1000+500);
    }

    function pickAndPlay(){
      if(cursor>=order.length){ cursor=0; order=shuffle(order); }
      const idx=order[cursor++]; updateLeft(); playSong(idx,true);
    }

    function startQuiz(){
      cursor=0; order=shuffle(order); updateLeft(); pickAndPlay();
    }
    function nextSong(){ stopPlayback(); pickAndPlay(); }
    function reveal(){ if(currentIndex==null) return; const s=SONGS[currentIndex]; titleEl.textContent=s.t; subEl.textContent=s.a; }

    // Controles
    document.getElementById('startBtn').addEventListener('click', startQuiz, { passive: true });
    document.getElementById('nextBtn').addEventListener('click', nextSong, { passive: true });
    document.getElementById('revealBtn').addEventListener('click', reveal, { passive: true });
    document.getElementById('randomPointBtn').addEventListener('click',()=>{ if(currentIndex!=null) playSong(currentIndex,true); }, { passive: true });
    document.getElementById('pauseBtn').addEventListener('click',()=>send('pauseVideo',[]), { passive: true });
    document.getElementById('resumeBtn').addEventListener('click',()=>send('playVideo',[]), { passive: true });
    document.getElementById('volume').addEventListener('change',()=>{
      const vol=Math.max(0,Math.min(100,parseInt(volumeEl.value||'70',10)));
      if (vol===0) send('mute', []); else { send('unMute', []); send('setVolume', [vol]); }
    }, { passive: true });

    // Render inicial
    updateLeft();
  </script>
</body>
</html>
